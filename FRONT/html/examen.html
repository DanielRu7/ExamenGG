<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Examen | CertiPro</title>
  <link rel="stylesheet" href="../css/estilos.css">
  <link rel="stylesheet" href="../css/examen.css">

</head>
<body>
  <header>
    <nav>
        <a href="#">
            <img class="logo" src="/FRONT/media/logo.png" alt="Logo CertiPro">
        </a>
        <p>Certificados que hablan tu lenguaje</p>
        
        
        <div class="user-controls">
            <span id="userName" ></span>
            
        </div>
    </nav>
  </header>

  <div class="examen">
    <div id="intro-examen">
    <h1>El conocimiento te persigue, pero t√∫ eres m√°s r√°pido üß†</h1>
    <button class="btn-azul" id="btnCargar">Comenzar examen</button>
  </div>
  
  <form id="quizForm" style="display:none;">
    <h2>Cuestionario de Ensamblador</h2>
    <div id="listaPreguntas"></div>
    <button type="submit" class="btn-azul">Enviar respuestas</button>
  </form>

  <div id="resultado"></div>


  </div>

  <footer>
    <div class="footer-content">
        <p>Todos los derechos reservados ¬© 2025 <strong>CertiPro</strong></p>
        <p>Suerte en TU Examen!!</p>
    </div>
  </footer>

  

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const API = "http://localhost:3000/api/questions";
      const quizForm = document.getElementById("quizForm");
      const listaPreguntas = document.getElementById("listaPreguntas");
      const resultado = document.getElementById("resultado");
      const btnCargar = document.getElementById("btnCargar");
      let preguntas = [];

      // Cargar preguntas del examen
      btnCargar.addEventListener("click", async () => {
        const token = localStorage.getItem("token");

        try {
          const res = await fetch(`${API}/start`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}` }
          });

          const data = await res.json();
          preguntas = data.questions || [];

          listaPreguntas.innerHTML = "";

          preguntas.forEach((q, index) => { 
            const div = document.createElement("div");
            div.className = "card";
            div.innerHTML = `
              <p><strong>${index + 1}.</strong> ${q.text}</p> 
              ${q.options.map(opt => `
                <label>
                  <input type="radio" name="q_${q.id}" value="${opt}"> ${opt}
                </label>
              `).join("")}
            `;
            listaPreguntas.appendChild(div);
          });

          quizForm.style.display = "block";
          resultado.innerHTML = "";
          document.getElementById("intro-examen").style.display = "none";

        } catch (error) {
          console.error("Error al cargar las preguntas:", error);
          alert("No se pudo cargar el examen.");
        }
      });

      // Enviar respuestas y procesar resultado
      quizForm.addEventListener("submit", async e => {
        e.preventDefault();

        const token = localStorage.getItem("token");
        if (!token) {
          alert("Debes iniciar sesi√≥n nuevamente.");
          return;
        }

        const answers = preguntas.map(q => {
          const selected = document.querySelector(`input[name="q_${q.id}"]:checked`);
          return { id: q.id, answer: selected ? selected.value : "" };
        });

        try {
          const res = await fetch(`${API}/submit`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ answers })
          });

          if (res.status === 401) {
            alert("Tu sesi√≥n ha expirado o el token es inv√°lido.");
            return;
          }

          const data = await res.json();
          quizForm.style.display = "none";

          // Mostrar resultados
          resultado.innerHTML = `
            <h2>Resultado: ${data.score}/${data.total}</h2>
            ${data.details.map(d => `
              <div class="card">
                <p><strong>${d.text}</strong></p>
                <p>Tu respuesta: <em>${d.yourAnswer ?? "(sin responder)"}</em></p>
                <p>Correcta: <strong>${d.correctAnswer}</strong></p>
                <p class="${d.correct ? "ok" : "bad"}">
                  ${d.correct ? "‚úî Correcto" : "‚úñ Incorrecto"}
                </p>
              </div>
            `).join("")}
          `;


          setTimeout(() => {
            if (data.score >= 6) {
              window.location.href = "aprobado.html";
            } else {
              window.location.href = "reprobado.html";
            }
          }, 9000); 

        } catch (error) {
          console.error("Error al enviar respuestas:", error);
          alert("Error al enviar tus respuestas.");
        }
      });
    });
  </script>
  <script src="../js/examen.js"></script>
</body>
</html>
